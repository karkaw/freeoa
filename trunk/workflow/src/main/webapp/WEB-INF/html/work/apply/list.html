<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xmlns:t>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
		<!-- Title and other stuffs -->
		<title>我的申请</title>
		<meta name="keywords" content="" />
		<meta name="description" content="" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="author" content="" />

        <#include "/html/head.html"/>
        <@head />

		<!-- jQuery -->
		<script>
			$(function() {

                //获取对象
                var data = null ;
                $.post("../../wf/object/get.do",{},function(resText){
                    data = resText
                    for(var i = 0 ; i < data.length ; i++ ){
                        var button = $("<lable class='btn btn-info'/>");
                        button.attr("id",data[i]._id);
                        button.text(data[i].name);
                        button.appendTo("#objectRight div:eq(0)");

                        //每个对象绑定事件
                        button.unbind("click").bind("click",function(){//点击对象时显示对象属性
                            var id = $(this).attr("id");
                            var attr = data[$(this).index()]["attribute"];

                             $("#objectRight > div:gt(1)").hide();
                            var row  = $('#objectRight div:eq(1)')
                            var div  =  $("<div/>",{id:id});
                            if($("div[id="+id+"]",$("#objectRight")).length >0 ){
                                $("div[id="+id+"]",$("#objectRight")).show();
                            }else{
                                div.appendTo("#objectRight");
                                for(var j = 0 ; j < attr.length ; j++ ){
                                    var clone = row.clone(true);
                                    $("div:eq(0) span",clone).text(attr[j]["attrName"]);
                                    $("input[name=attrCode]",clone).val(attr[j]["attrCode"]);
                                    clone.appendTo(div);
                                    clone.show();
                                }
                            }
                        });
                    }

                    //Modal提交按钮绑定提交事件,放在请求里面  是为了避免JS的加载问题
                    UI.get("applyModle").getSubmitBtn().unbind("click").bind("click",function(){
                        //提交表单
                        var form = new UI.Form({id:"applyForm"});
                        var apply = UI.getFormParam($("#applyForm div:eq(0) .panel-body"));

                        var rows =  $("#objectRight  .row:gt(1)")
                        var objRight = [] ;
                        rows.each(function(idx,row){
                            var code  =  $("input[name=attrCode]",$(row)).val();
                            var read  =  $("input[name=read]",$(row)).is(":checked");
                            var write =  $("input[name=write]",$(row)).is(":checked");

                            if(read)    objRight.push("read:" + code) ;
                            if(write)   objRight.push("write:" + code) ;

                        });

                        apply.objRight = objRight ;
                        form.submit(apply,function(){
                            UI.get("applyModle").hide();
                            UI.get("applyGrid").reload();
                        });
                    });


                });

                //添加角色
				var widget = UI.get("applyWidget");
				var addbut = widget.addButton('addbnt', '添加');
                addbut.bind("click",function(){
                     var modal = UI.get("applyModle").show();
                });

                //多选删除
                var delbut = widget.addButton('delbnt', '删除');
                delbut.unbind("click").bind("click",function(){
                    var ids = UI.get("applyGrid").getSelectValues(true);
                    if(ids != null){
                        deleteResource(ids);
                    }
                });

                //删除按钮
                $("#applyGrid").find("tr a:eq(1)").bind("click",function(){
                    var id = $(this).parent().parent("tr").find("input:checkbox").val();
                    if(id != null){
                        deleteResource([id]);
                    }
                });

                //提交删除数据
                var deleteResource = function(data){
                    var form = new UI.Form({url:'delete.do'});
                    form.submit({"ids":data},function(){
                       // UI.get("applyGrid").reload();   //提交完成刷新grid
                       UI.get("applyGrid").removeRowById(data);
                    })
                };

			});
		</script>
</head>

<body>
	<!-- Header starts -->
	<#include "/html/header.html"/>
	<!-- Header ends -->

	<!-- Main starts -->
	<div class="main-container" id="main-container">
		<div class="main-container-inner">
			<#include "/html/sidebar.html"/>

			<div class="main-content">
				<div class="breadcrumbs" id="breadcrumbs">
					<ul class="breadcrumb">
						<li><i class="icon-home home-icon"></i> <a href="#">首页</a></li>
						<li class="active">控制台</li>
					</ul>
					<!-- .breadcrumb -->

					<div class="nav-search" id="nav-search">
						<form class="form-search">
							<span class="input-icon"> <input type="text"
								placeholder="Search /html." class="nav-search-input"
								id="nav-search-input" autocomplete="off" /> <i
								class="icon-search nav-search-icon"></i>
							</span>
						</form>
					</div>
					<!-- #nav-search -->
				</div>

				<!-- page-content stats -->
				<div class="page-content">
					<div class="page-header">
						<h1>
							控制台 <small><i class="icon-double-angle-right"></i>我的申请单</small>
						</h1>
					</div>
					<!-- /.page-header -->

					<div class="row">
						<div class="col-xs-12">
                        <@ui.widget id="applyWidget" title="我的申请单列表">
                            <@ui.grid id="applyGrid"  action="jlist.do"  height="450px" >
                                <@ui.column type='checkbox'   name="_id"></@ui.column>
                                <@ui.column title="名称"      name="applyName"></@ui.column>
                                <@ui.column title="编码"      name="applyCode" class="hidden-sm hidden-xs"></@ui.column>
                                <@ui.column title="操作" align="center">
                                    <a>修改</a> <a>删除</a>
                                </@ui.column>
                            </@ui.grid>
                        </@ui.widget>
						</div>
					</div>
				</div>
				<!-- page-content end -->
			</div>
			<!-- Main end -->
        </div>
    </div>
    <@ui.modal id="applyModle" title="申请"  gridId="applyGrid">
    <fieldset>
        <@ui.form id="applyForm" action="save.do" class="form-horizontal" hasButton=false submitForward="list.do" submitType="hand">

        </@ui.form>
    </fieldset>
    </@ui.modal>
</body>
</html>